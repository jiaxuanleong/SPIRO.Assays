# process_rootgrowth_data.R - 
#
#   takes data generated by cleanup_rootgrowth_data.R and estimates per-group root growth rates.
# 

# clean slate
rm(list=ls())
source('common/common.R')
p_load(readr, ggplot2, dplyr, glmmTMB, emmeans, multcomp, multcompView, ggeffects)

dir <- choose_dir()

resultsdir <- paste0(dir, '/Results')
outdir <- paste0(resultsdir, '/Root Growth')
rundir <- create_rundir(outdir)

if (file.exists(paste0(outdir, "/rootgrowth.postQC.tsv"))) {
  data <- read_tsv(paste0(outdir, '/rootgrowth.postQC.tsv'),
                   col_types=c(UID=col_character(), Group=col_character(), ElapsedHours=col_skip(),
                               RelativeElapsedHours=col_double(), PrimaryRootLength=col_double(),
                               Date=col_skip()))
} else {
  stop("rootgrowth.postQC.tsv not found in specified directory. Did you run cleanup_rootgrowth_data.R?\n")
}

# if Group is set to NA, do not include in analysis
data <- data[which(!is.na(data$Group)),]

# copy postQC input file to rundir for reference
dir.create(paste0(rundir, '/QC Results'))
file.copy(paste0(outdir, "/rootgrowth.postQC.tsv"), paste0(rundir, '/QC Results'))
file.copy(paste0(outdir, "/germination-perseed.tsv"), paste0(rundir, '/QC Results'))

# loop to ask the user to choose the control group
groups <- as.character(unique(data$Group))
ngroups <- length(groups)

# fit the mixed model
cat("Fitting the model, hold tight...\n")
if (ngroups > 1) {
  fit.glmmTMB <- glmmTMB(data=data,
          formula=PrimaryRootLength ~ 1 + poly(RelativeElapsedHours, 2) * Group + (1+poly(RelativeElapsedHours, 2) | UID),
          REML = T) -> fit.glmmTMB
  fit.glmmTMB %>% emtrends(~Group, var="RelativeElapsedHours") -> fit.trend
  fit.cld <- cld(fit.trend)
  fit.cld %>% as_tibble %>%
    dplyr::select(c(Group, .group)) %>%
    rename(Tukey.CLD = .group) -> fit.cld
  fit.pwpp <- pwpp(fit.trend, values=F) + theme_bw()
  
  write.table(fit.cld, file=paste0(rundir, '/Tukey CLD.tsv'), row.names=F, sep='\t')
  ggsave(fit.pwpp, filename = paste0(rundir, "/Pairwise p-value plot.pdf"), width=25, height=15, units="cm")
} else {
  fit.glmmTMB <- glmmTMB(data=data,
          formula=PrimaryRootLength ~ 1 + poly(RelativeElapsedHours, 2) + (1+poly(RelativeElapsedHours, 2) | UID),
          REML = T)
}

# make trend graph
if (ngroups > 1) {
  fit.glmmTMB %>% ggeffect(terms = c("RelativeElapsedHours [0,24,48,72,96,120,144]","Group")) -> glmmTMB_model_ggeffects
  data %>% rename(group=Group, x=RelativeElapsedHours, predicted=PrimaryRootLength) %>%
    dplyr::select(c(UID, x, predicted, group)) -> plotting
  glmmTMB_model_ggeffects %>% as_tibble %>%
    ggplot(aes(x=x, y=predicted, ymin=conf.low, ymax=conf.high, fill=group, group=group)) +
    geom_line(linetype="dashed") + 
    geom_ribbon(alpha=.5) +
    geom_line(data=plotting, aes(group=UID, ymin=NULL, ymax=NULL), alpha=.7) +
    facet_wrap(~group) +
    labs(fill='Group', y="Predicted primary root length (cm)", x="Time since root emergence (h)") -> p
  ggsave(p, filename=paste0(rundir, '/Model prediction overview.pdf'), width=25, height=25, units="cm")
} else {
  fit.glmmTMB %>% ggeffect(terms = c("RelativeElapsedHours [0,24,48,72,96,120,144]")) -> glmmTMB_model_ggeffects
  data %>% rename(group=Group, x=RelativeElapsedHours, predicted=PrimaryRootLength) %>%
    dplyr::select(c(UID, x, predicted, group)) -> plotting
  glmmTMB_model_ggeffects %>% as_tibble %>%
    ggplot(aes(x=x, y=predicted, ymin=conf.low, ymax=conf.high)) +
    geom_line(linetype="dashed") + 
    geom_ribbon(alpha=.5) +
    geom_line(data=plotting, aes(group=UID, ymin=NULL, ymax=NULL), alpha=.7) +
    labs(y="Predicted primary root length (cm)", x="Time since root emergence (h)") -> p
  ggsave(p, filename=paste0(rundir, '/Model prediction overview.pdf'), width=25, height=25, units="cm")
}

glmmTMB_model_ggeffects %>% as_tibble %>% 
  arrange(group, x) %>%
  rename(RelativeHours = x, PredictedRootLength = predicted, Group = group) %>%
  dplyr::select(c(Group, RelativeHours, PredictedRootLength, std.error, conf.low, conf.high)) %>%
  mutate(PredictedRootLength=round(PredictedRootLength, 3), std.error=round(std.error, 3), conf.low=round(conf.low, 3),
         conf.high=round(conf.high, 3)) %>%
  filter(RelativeHours > 0) -> root.table

write.table(root.table, file=paste0(rundir, '/Predicted Root Lengths.tsv'), row.names=F, sep='\t')

p <- ggplot(root.table, aes(x=Group, y=PredictedRootLength, ymin=conf.low, ymax=conf.high, fill=as.ordered(RelativeHours))) + 
  geom_col(position="dodge", color="black") +
  geom_errorbar(position="dodge") +
  scale_fill_brewer(palette='RdYlBu') +
  theme_bw() +
  labs(fill='Hours', y='Predicted root length (cm)')
ggsave(p, filename=paste0(rundir, '/Root length barchart.pdf'), width=25, height=15, units="cm")

cat(paste0('Wrote statistics and graphs to ', rundir, '.\n'))
